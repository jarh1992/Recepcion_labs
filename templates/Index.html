{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Registro Labs</title>
    <link rel="stylesheet" href="{% static "css/bootstrap.min.css" %}">
    <link rel="stylesheet" href="{% static "css/fontawesome-all.min.css" %}">
    <script src="{% static "js/jquery-3.3.1.min.js" %}"></script>
    <script src="{% static "js/popper.min.js" %}"></script>
    <script src="{% static "js/bootstrap.min.js" %}"></script>
</head>
<body>
    <main class="container" style="margin-top: 20px;">
        <div class="row">
            <div class="input-group col-sm-10">
                <input class="form-control" id="input_cod" type="number" placeholder="codigo">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" id="search" name="search" onclick="consult()">{% csrf_token %}
                        Buscar <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            <div class="dropdown col-sm-2">
                <button class="btn btn-info dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Programas acad.
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenu2">
                    <button class="dropdown-item" type="button" data-toggle="modal" data-target="#modalNAP">Nuevo</button>
                    <button class="dropdown-item" type="button" data-toggle="modal" data-target="#modalUAP">Actualizar</button>
                    <button class="dropdown-item" type="button" data-toggle="modal" data-target="#modalDAP">Eliminar</button>
                </div>
            </div>
        </div>
        <div class="row mt-3" align="center">
            <div class="table-responsive">
                <table class="table table-bordered table-dark">
                    <thead>
                        <tr>
                            <th scope="col">Nombre</th>
                            <th scope="col">Cedula</th>
                            <th scope="col">codigo</th>
                            <th scope="col">Programa</th>
                            <th scope="col">Hora de entrada</th>
                            <th scope="col">Hora de salida</th>
                            <th scope="col">Equipo</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for object in list %}
                        <tr>
                            <td>{{ object.student.name }}</td>
                            <td>{{ object.student.ced }}</td>
                            <td>{{ object.student.cod }}</td>
                            <td>{{ object.student.program }}</td>
                            <td>{{ object.entry_time }}</td>
                            <td>{{ object.departure_time }}</td>
                            <td>{{ object.pc.num }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    {% include 'modalNAP.html' %}
    {% include 'modalUAP.html' %}
    {% include 'modalDAP.html' %}

    {% include 'modalSAS.html' %}

    <div class="modal fade" tabindex="-1" id="modalAoE" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Guardar y Agregar</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Modal body text goes here.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" tabindex="-1" id="modalFinServ" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Guardar y Agregar</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Modal body text goes here.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" tabindex="-1" id="modalAddProg" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Programas</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <!--<form action="{% url 'index' %}" method="post">
                    <div class="modal-body">
                        <input name="flag" type="text" value="4" hidden>
                        <div class="form-group row">
                            <label for="prog_name" class="col-sm-4">Nombre:</label>
                            <div class="col-sm-8">
                                <input name="prog_name" id="prog_name" class="form-control" maxlength="60" required=""type="text">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="prog_cod" class="col-sm-4">Codigo:</label>
                            <div class="col-sm-8">
                                <input name="prog_cod" id="prog_cod" class="form-control" maxlength="60" required="" type="text">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button name="del_prog" type="submit" class="btn btn-danger">Eliminar</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                        <button name="add_prog" type="submit" class="btn btn-primary">Guardar</button>
                        <button name="upd_prog" type="submit" class="btn btn-primary">Actualizar</button>
                    </div>
                </form>-->
                <div class="modal-body">
                    {{ form_addprog }}
                </div>
                <div class="modal-footer">
                    <button name="del_prog" type="submit" class="btn btn-danger">Eliminar</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button name="add_prog" type="submit" class="btn btn-primary">Guardar</button>
                    <button name="upd_prog" type="submit" class="btn btn-success">Actualizar</button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">

        $("#input_cod").keyup(function(event) {
            if (event.keyCode === 13) {
                $("#search").click();
            }
        });

        function consult(){
            const csrftoken = getCookie('csrftoken');
            let id = $("#input_cod").val();
            let request = $.ajax({
                url: '{% url 'index' %}',
                type: "POST",
                data: {
                    'id': id,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]')[0].value,
                },
                dataType: "html"
            });

            request.done(function(msg) {
                let obj = JSON.parse(msg);
                switch(obj.response) {
                    case 0:
                        alert("Error");
                        break;
                    case 1:
                        $('#sas_progs').empty();
                        $.each(obj.programs, function (k, v){
                            let option = $("<option class=''></option>");
                            option.text(v.name);
                            option.val(v.cod);
                            $("#sas_progs").append(option);
                        });
                        $("#modalSAS").modal();
                        break;
                    case 2:
                        $("#modalAoE").modal();
                        break;
                    case 3:
                        $("#modalFinServ").modal();
                        break;
                    case 4:
                        $("#modalAddProg").modal();
                        break;
                }
            });

            request.fail(function(jqXHR, textStatus) {
                alert( "Request failed: " + textStatus );
            });

            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                let cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
    </script>
</body>
</html>